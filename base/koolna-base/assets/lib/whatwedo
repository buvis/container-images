#!/usr/bin/env python3
"""
whatwedo - Work session context manager

Tracks and manages development work session context including repo, branch,
issue, PR, PRD, and task information.
"""

import argparse
import json
import os
import subprocess
import sys
from pathlib import Path


class WorkSessionContext:
    """Manages work session context data."""
    
    STATE_FILE = Path.home() / ".whatwedo_state.json"
    WORKSPACE_DIR = Path("/workspace")
    
    CONTEXT_ITEMS = ["repo", "branch", "issue", "pr", "prd", "task"]
    READ_ONLY_ITEMS = {"repo", "branch"}
    
    def __init__(self):
        self.state = self._load_state()
    
    def _load_state(self) -> dict:
        """Load state from JSON file."""
        if self.STATE_FILE.exists():
            try:
                with open(self.STATE_FILE, 'r') as f:
                    return json.load(f)
            except (json.JSONDecodeError, IOError):
                return {}
        return {}
    
    def _save_state(self):
        """Save state to JSON file."""
        try:
            with open(self.STATE_FILE, 'w') as f:
                json.dump(self.state, f, indent=2)
        except IOError as e:
            print(f"Error saving state: {e}", file=sys.stderr)
            sys.exit(1)
    
    def _get_git_repo(self) -> str:
        """Extract repo from git remote URL."""
        try:
            result = subprocess.run(
                ["git", "config", "--get", "remote.origin.url"],
                cwd=self.WORKSPACE_DIR,
                capture_output=True,
                text=True,
                check=True
            )
            remote_url = result.stdout.strip()
            
            # Parse github.com or gitlab.com URLs
            for domain in ["github.com", "gitlab.com"]:
                if domain in remote_url:
                    # Handle both HTTPS and SSH formats
                    if remote_url.startswith("https://"):
                        # https://github.com/user/repo.git
                        parts = remote_url.split(domain + "/")
                        if len(parts) == 2:
                            repo = parts[1].rstrip("/").removesuffix(".git")
                            return repo
                    elif remote_url.startswith("git@"):
                        # git@github.com:user/repo.git
                        parts = remote_url.split(domain + ":")
                        if len(parts) == 2:
                            repo = parts[1].rstrip("/").removesuffix(".git")
                            return repo
            
            return "NOT SET"
        except (subprocess.CalledProcessError, FileNotFoundError):
            return "NOT SET"
    
    def _get_git_branch(self) -> str:
        """Get current git branch."""
        try:
            result = subprocess.run(
                ["git", "rev-parse", "--abbrev-ref", "HEAD"],
                cwd=self.WORKSPACE_DIR,
                capture_output=True,
                text=True,
                check=True
            )
            return result.stdout.strip()
        except (subprocess.CalledProcessError, FileNotFoundError):
            return "NOT SET"
    
    def get(self, item: str) -> str:
        """Get a context item value."""
        if item not in self.CONTEXT_ITEMS:
            print(f"Error: Unknown context item '{item}'", file=sys.stderr)
            print(f"Valid items: {', '.join(self.CONTEXT_ITEMS)}", file=sys.stderr)
            sys.exit(1)
        
        if item == "repo":
            return self._get_git_repo()
        elif item == "branch":
            return self._get_git_branch()
        else:
            return self.state.get(item, "NOT SET")
    
    def set(self, item: str, value: str):
        """Set a context item value."""
        if item not in self.CONTEXT_ITEMS:
            print(f"Error: Unknown context item '{item}'", file=sys.stderr)
            print(f"Valid items: {', '.join(self.CONTEXT_ITEMS)}", file=sys.stderr)
            sys.exit(1)
        
        if item in self.READ_ONLY_ITEMS:
            print(f"Error: Cannot set '{item}' - it is determined automatically from git", file=sys.stderr)
            sys.exit(1)
        
        self.state[item] = value
        self._save_state()
    
    def print_all(self):
        """Print all context items."""
        for item in self.CONTEXT_ITEMS:
            value = self.get(item)
            print(f"{item}: {value}")


def main():
    parser = argparse.ArgumentParser(
        description="Work session context manager",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  whatwedo                    # Show all context items
  whatwedo get repo           # Get repo value
  whatwedo set issue 123      # Set issue number
  whatwedo set prd /path/to/prd.txt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Command to execute")
    
    # get command
    get_parser = subparsers.add_parser("get", help="Get a context item value")
    get_parser.add_argument("item", help="Context item to get")
    
    # set command
    set_parser = subparsers.add_parser("set", help="Set a context item value")
    set_parser.add_argument("item", help="Context item to set")
    set_parser.add_argument("value", help="Value to set")
    
    args = parser.parse_args()
    
    context = WorkSessionContext()
    
    if args.command == "get":
        print(context.get(args.item))
    elif args.command == "set":
        context.set(args.item, args.value)
    else:
        # No command - print all
        context.print_all()


if __name__ == "__main__":
    main()
